<!DOCTYPE html>

<head>
    <title>Cambio de contraseña</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/change_password.css">

      <style>

        </style>

</head>

<body>
    <div class="contenedor">

        <h1>Change password </h1>
       
        <form id="changePassword" class="form" action="http://localhost:8080/CRUDBankServerSide/webresources/customer/">

            <label for="ActualPassword">Current password</label>
            <input id="actualPassword" name="actualPassword" type="password" />

            <label for="NewPassword">New password</label>
            <input id="newPassword" name="newPassword" type="password" />

            <label for="confirmPassword">Confirm password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" />
            <button class="button" id="ChangePasswordConfirm"
                onclick="handleChangePasswordOnClick(event);">Change Password</button>
        </form>
                <div id="responseMsg"></div>

    </div>
<script type="text/javascript">
   
        function handleChangePasswordOnClick (event) {
            try{
                // obtenemos referencias              
                const changePassword = document.getElementById("changePassword");
                const msgBox = document.getElementById("responseMsg");
               
                // obtenemos email solo para validar cambio de contraseña
                const emailUser = document.getElementById("emailUser");
           
                // obtenemos los elementos del form
                const actualPassword = document.getElementById("actualPassword");
                const newPassword = document.getElementById("newPassword");
                const confirmPassword = document.getElementById("confirmPassword");
               
               
               
                event.preventDefault();
                event.stopPropagation();
               
                // valida si estan vacios:              
                if(actualPassword.value.trim()===""||newPassword.value.trim()==="" || confirmPassword.value.trim()==="")
                    throw new Error("any imput must be filled.");
           
                // Valida si la Nueva contraseña cumple con requisitos:            
                const passwordRegExp=
                    new RegExp (/^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{5,20}$/);
                if (!passwordRegExp.exec(newPassword.value.trim()))
                    throw new Error("New password has not a valid format. Please try again");
                               
               // Valida si la contraseña actual coincide con la nueva contraseña
                if(newPassword.value.trim() === actualPassword.value.trim())
                throw new Error("The password and the new password are the same");
                      
                               
                // Valida si la nueva contraseña coincide con el campo de confirmacion de contraseña.
                if(newPassword.value.trim()!== confirmPassword.value.trim())
                throw new Error("Your password and new password do not match.");
            

                // Verifica si la contraseña coincide con la del sessionStorage
                const storedPassword = sessionStorage.getItem("customer.password");
                if (actualPassword.value.trim() !== storedPassword) {
                    throw new Error("The current password is incorrect.");
                }

                // Cambiar contraseña del sessionStorage        
                sessionStorage.setItem("customer.password", newPassword.value.trim());
                msgBox.className = 'success';
                msgBox.textContent = "Password successfully changed in sessionStorage.";
         
         
         
            // llamar a la funcion para llamar a los datos
             sendRequestAndProcessResponse();
             
            } catch (error) {
              //Show error messages in red styled div
                    const msgBox = document.getElementById("responseMsg");
                    msgBox.className = 'error';
                    msgBox.textContent = 'Error: ' + error.message;
                    msgBox.style.display = 'block';              
               
            }

       }
       
        function sendRequestAndProcessResponse() {
                 // obtenemos referencias
                const changePassword = document.getElementById("changePassword");
                const msgBox = document.getElementById("responseMsg")
               
                // Obtenemos valor de los campos
                const valueEmailUser = emailUser.value.trim();
                const valueActualPassword = actualPassword.value.trim();
                const valueNewPassword = newPassword.value.trim();
                const valueConfirmPassword = confirmPassword.value.trim();
               
               // Realizamos peticion usando API Fetch

            fetch("http://localhost:8080/CRUDBankServerSide/webresources/customer/", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"},

                body: JSON.stringify ({
                    
                    id: sessionStorage.getItem("customer.id"),
                    firstName: sessionStorage.getItem("customer.firstsName"),
                    lastName: sessionStorage.getItem("lastName"),
                    middleInitial: sessionStorage.getItem("customer.middleInitial"),
                    email: sessionStorage.getItem("customer.email"),
                    password: valueNewPassword,
                    phone: sessionStorage.getItem("customer.phone"),
                    street: sessionStorage.getItem("customer.street"),
                    city: sessionStorage.getItem("customer.city"),
                    state: sessionStorage.getItem("customer.state"),
                    zip: sessionStorage.getItem("customer.zip")


                })
               
            })
.then(res => {
  if (res.ok) {
    msgBox.className = 'success';
    msgBox.textContent = "Password successfully changed in database.";
    window.location.replace("./prueba.html");
  } else {
    msgBox.className = 'error';
    msgBox.textContent = "Error: failed to update password (HTTP " + res.status + ")";
  }
  msgBox.style.display = 'block';
})
.catch(err => {
  msgBox.className = 'error';
  msgBox.textContent = "Server error: " + err;
  msgBox.style.display = 'block';
});
       
        }
        
        
       
       
       
</script>
</body>

</html>
